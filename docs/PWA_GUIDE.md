# Progressive Web App (PWA) Implementation Guide

This document provides an overview of the PWA implementation in FitCoachPro, including how data synchronization works and best practices for maintaining the PWA functionality.

## Overview

FitCoachPro is implemented as a Progressive Web App (PWA) using Next.js and next-pwa. This allows users to:

1. Install the app on their devices
2. Use the app offline
3. Sync data when they come back online
4. Receive updates automatically

## Key Components

### 1. Service Workers

We use two service workers:

- **Main Service Worker (sw.js)**: Generated by next-pwa, handles caching and offline functionality
- **Custom Service Worker (custom-sw.js)**: Handles data synchronization and cross-tab communication

### 2. Data Synchronization

Data synchronization is handled by:

- **OfflineProvider**: Manages online/offline state and provides data synchronization methods
- **useOfflineData Hook**: Provides CRUD operations that work both online and offline
- **IndexedDB**: Stores data locally when offline

### 3. Manifest

The app manifest (`manifest.ts`) defines how the app appears when installed on a device.

## How Data Synchronization Works

1. When online, data is saved directly to Supabase and cached locally
2. When offline, data is saved to IndexedDB and added to a sync queue
3. When the app comes back online, the sync queue is processed
4. After syncing, components are notified to refresh their data

### Data Change Notification Flow

1. When data changes (create/update/delete), a notification is sent via `notifyDataChange`
2. Components subscribed to that table receive the notification and refresh their data
3. If multiple tabs are open, the service worker broadcasts the change to all tabs
4. Each tab then refreshes the affected data

## Maintaining the PWA

### Adding New Features

When adding new features:

1. Use the `useOfflineData` hook for data operations
2. Subscribe to data changes for real-time updates
3. Handle both online and offline states
4. Test thoroughly in offline mode

### Updating Service Workers

If you need to modify service worker behavior:

1. Update `custom-sw.js` for custom behavior
2. Update `next.config.ts` for caching strategies
3. Test thoroughly after changes

### Updating the Manifest

When updating the app manifest:

1. Modify `app/manifest.ts`
2. Update icons if needed
3. Test installation on various devices

## Best Practices

1. **Always handle offline state**: Check `isOnline` before operations that require network
2. **Use optimistic UI updates**: Update the UI immediately, then sync in the background
3. **Provide clear feedback**: Show toast notifications for sync status
4. **Test offline functionality**: Regularly test the app in offline mode
5. **Keep service workers simple**: Complex service workers can be hard to debug

## Troubleshooting

### Common Issues

1. **Data not syncing**: Check the sync queue in IndexedDB
2. **Service worker not updating**: Clear site data or use the "Update on reload" option in DevTools
3. **Hydration errors**: Ensure server and client render the same content

### Debugging Tools

1. **Chrome DevTools**: Application tab > Service Workers
2. **Lighthouse**: Audit PWA functionality
3. **IndexedDB browser**: View and modify local data

## Resources

- [Next.js PWA Documentation](https://github.com/shadowwalker/next-pwa)
- [Workbox Documentation](https://developers.google.com/web/tools/workbox)
- [PWA Builder](https://www.pwabuilder.com/)
- [MDN Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
